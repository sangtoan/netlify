<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoán vị file LaTeX</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #f1f1f1;
            --hover-color: #45a049;
            --button-color: #4CAF50;
            --text-color: white;
            --button-text-color: yellow;
        }

        body {
            background-color: var(--secondary-color);
            font-family: Arial, sans-serif;
        }

        .container {
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .menu {
            width: 100%;
            background-color: var(--primary-color);
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .menu a {
            float: left;
            display: block;
            color: var(--text-color);
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .menu a:hover {
            background-color: var(--hover-color);
            color: var(--text-color);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
        }

        .nav-tabs .nav-item.show .nav-link, .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--secondary-color);
            border-color: var(--primary-color) var(--primary-color) var(--secondary-color);
        }

        .nav-tabs .nav-link {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            transition: background-color 0.3s;
        }

        .nav-tabs .nav-link:hover {
            background-color: var(--hover-color);
            color: var(--text-color);
        }

        .form-group label {
            font-weight: bold;
        }

        .btn-primary, .btn-success, .btn-secondary {
            background-color: var(--button-color);
            border: none;
            color: var(--button-text-color);
            width: 22%;
            margin-right: 10px;
        }

        .btn-primary:hover, .btn-success:hover, .btn-secondary:hover {
            background-color: var(--hover-color);
            color: var(--text-color);
        }

        .btn:last-child {
            margin-right: 0;
        }

        .d-flex {
            justify-content: center !important;
        }
    </style>
</head>

<body>
    <div class="menu">
        <a href="index.html">Home</a>
        <a href="#contact">Contact</a>
        <a href="tron_de.html">Trộn Đề</a>
        <a href="fixcode.html">Fix Code</a>
        <a href="find_latex.html">Tìm Kiếm</a>
        <a href="Ve_hinh.html">Vẽ Hình</a>
        <a href="tuong_tu.html">Đề Tương Tự</a>
        <a href="menu_tree.html">Menu ID</a>
    </div>
    <div class="container">
        <h1>Trộn Đề Cấu Trúc 2025</h1>
        <ul class="nav nav-tabs d-flex justify-content-center" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="upload-tab" data-toggle="tab" href="#upload" role="tab" aria-controls="upload" aria-selected="true">Tải lên file</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="paste-tab" data-toggle="tab" href="#paste" role="tab" aria-controls="paste" aria-selected="false">Dán nội dung</a>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="upload" role="tabpanel" aria-labelledby="upload-tab">
                <form id="uploadForm" method="post" enctype="multipart/form-data" class="mt-3">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="school">Tên Trường:</label>
                            <input type="text" class="form-control" id="school" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="teacher">Tên Giáo Viên:</label>
                            <input type="text" class="form-control" id="teacher" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="exam">Tên Kỳ Thi:</label>
                            <input type="text" class="form-control" id="exam" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="subject">Tên Môn Thi:</label>
                            <input type="text" class="form-control" id="subject" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="time">Thời Gian Làm Bài (phút):</label>
                            <input type="number" class="form-control" id="time" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="made">Mã Đề Thi:</label>
                            <input type="text" class="form-control" id="made" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="uploadFile">Chọn file LaTeX:</label>
                            <input type="file" class="form-control" id="uploadFile" name="file" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="numFiles">Số lượng file hoán vị:</label>
                            <input type="number" class="form-control" id="numFiles" name="num_files" min="1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="hoanViType">Loại hoán vị:</label>
                            <select class="form-control" id="hoanViType" name="hoan_vi_type">                                
                                <option value="cau_truc">Trộn Đề Theo Mức Độ</option>
                                <option value="ngoac">Trộn Các Phương Án</option>
                                <option value="giu_nguyen">Giữ Nguyên Đề</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="headerType">Tuỳ chọn main:</label>
                            <select class="form-control" id="headerType" name="header_type">
                                <option value="default">Mặc định</option>
                                <option value="option1">Option 1</option>
                                <option value="option2">Option 2</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="phieuTo">Phiếu Tô:</label>
                            <select class="form-control" id="phieuTo" name="phieu_to">
                                <option value="phieu0">Mặc Định</option>
                                <option value="phieu1">Phiếu TN Maker</option>
                                <option value="phieu2">Phiếu Chấm Thi</option>
                                <option value="phieu3">Phiếu 3</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="dapAn">Đáp Án:</label>
                            <select class="form-control" id="dapAn" name="dap_an">
                                <option value="dap_an_1">Đáp án loại 1</option>
                                <option value="dap_an_2">Đáp án loại 2</option>
                                <option value="dap_an_3">Đáp án loại 3</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-4">
                        <button type="submit" class="btn btn-primary">Tải file lên</button>
                        <button id="permuteButton" class="btn btn-success">Trộn Đề </button>
                        <button id="downloadXlsxButton" class="btn btn-secondary">Trộn Đề + TN Maker</button>
                        <button id="downloadXlsxButtonTwo" class="btn btn-secondary">Trộn Đề + Chấm Thi</button>
                    </div>
                </form>
            </div>
            <div class="tab-pane fade" id="paste" role="tabpanel" aria-labelledby="paste-tab">
                <form id="pasteForm" class="mt-3">
                    <div class="form-group">
                        <label for="pasteContent">Dán nội dung LaTeX:</label>
                        <textarea class="form-control" id="pasteContent" name="content" rows="10" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="numPasteFiles">Số lượng file hoán vị:</label>
                            <input type="number" class="form-control" id="numPasteFiles" name="num_files" min="1" required>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="hoanViTypePaste">Loại hoán vị:</label>
                            <select class="form-control" id="hoanViTypePaste" name="hoan_vi_type">
                                <option value="ngoac">Hoán vị các cặp ngoặc</option>
                                <option value="cau_truc">Hoán vị các cặp ngoặc và cấu trúc</option>
                                <option value="giu_nguyen">Giữ nguyên</option>
                            </select>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="headerTypePaste">Loại khai báo đầu file:</label>
                            <select class="form-control" id="headerTypePaste" name="header_type">
                                <option value="default">Default</option>
                                <option value="option1">Option 1</option>
                                <option value="option2">Option 2</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="phieuToPaste">Phiếu Tô:</label>
                            <select class="form-control" id="phieuToPaste" name="phieu_to">
                                <option value="phieu1">Phiếu 1</option>
                                <option value="phieu2">Phiếu 2</option>
                                <option value="phieu3">Phiếu 3</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="dapAnPaste">Đáp Án:</label>
                            <select class="form-control" id="dapAnPaste" name="dap_an">
                                <option value="dap_an_1">Đáp án loại 1</option>
                                <option value="dap_an_2">Đáp án loại 2</option>
                                <option value="dap_an_3">Đáp án loại 3</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Trộn Đề</button>
                </form>
            </div>
        </div>
        <div class="mt-5" id="resultSection" style="display: none;">
            <h2>Kết quả:</h2>
            <div id="results"></div>
        </div>
        <table id="latexTable" class="table mt-3">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>ID</th>
                    <th>ID Ý NGHĨA</th>
                    <th>Nội dung câu hỏi</th>
                    <th>Không Trộn</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>



    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    
    <script>
function loadJSON(filePath, callback) {
        var xhr = new XMLHttpRequest();
        xhr.overrideMimeType("application/json");
        xhr.open('GET', filePath, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                callback(JSON.parse(xhr.responseText));
            }
        };
        xhr.send(null);
    }

function copyToClipboard(text) {
            let tempTextarea = document.createElement('textarea');
            tempTextarea.value = text;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);
            alert('Đã copy nội dung vào clipboard!');
        }

function getPhieuToContent(phieuTo) {
        switch (phieuTo) {
            case 'phieu0':
                return ``;
            case 'phieu1':
                return `
\\{Phiếu Tô 1}
\\begin{itemize}
\\item Nội dung 1 của Phiếu 1
\\item Nội dung 2 của Phiếu 1
\\item Nội dung 3 của Phiếu 1
\\end{itemize}
`;
            case 'phieu2':
                return `
{Phiếu Tô 2}
\\begin{itemize}
\\item Nội dung 1 của Phiếu 2
\\item Nội dung 2 của Phiếu 2
\\item Nội dung 3 của Phiếu 2
\\end{itemize}
`;
            case 'phieu3':
                return `
\\section*{Phiếu Tô 3}
\\begin{itemize}
\\item Nội dung 1 của Phiếu 3
\\item Nội dung 2 của Phiếu 3
\\item Nội dung 3 của Phiếu 3
\\end{itemize}
`;
            default:
                return `
\\section*{Phiếu Tô}
\\begin{itemize}
\\item Nội dung mặc định
\\end{itemize}
`;
        }
    }

        function extractChoices(text) {
            const regex = /\\choice\s*(\{[^}]*\})\s*(\{[^}]*\})\s*(\{[^}]*\})\s*(\{[^}]*\})/;
            const match = text.match(regex);
            if (match) {
                for (let i = 1; i <= 4; i++) {
                    if (match[i].includes('\\True')) {
                        return String.fromCharCode(64 + i); // Chuyển đổi sang A, B, C, D
                    }
                }
            }
            return ""; // Trả về chuỗi rỗng nếu không có lựa chọn đúng
        }
    
        function extractTrueFalse(text) {
            const regex = /\\choiceTF\s*(\{[^}]*\})\s*(\{[^}]*\})\s*(\{[^}]*\})\s*(\{[^}]*\})/;
            const match = text.match(regex);
            if (match) {
                return match.slice(1, 5).map(choice => choice.includes('\\True') ? 'Đ' : 'S').join('');
            }
            return "SSSS"; // Trả về SSSS nếu không có lựa chọn đúng/sai
        }
    
        function extractShortAnswer(text) {
            const regex = /\\shortans\{([^}]*)\}/;
            const match = text.match(regex);
            if (match) {
                return match[1].trim();
            }
            return ""; // Trả về chuỗi rỗng nếu không tìm thấy câu trả lời
        }
    
        function layCacNgoacLon(text) {
            let ngoacLon = [];
            let demNgoac = 0;
            let batDau = null;
    
            for (let i = 0; i < text.length; i++) {
                let kyTu = text[i];
                if (kyTu === "{") {
                    if (demNgoac === 0) {
                        batDau = i;
                    }
                    demNgoac += 1;
                } else if (kyTu === "}") {
                    demNgoac -= 1;
                    if (demNgoac === 0 && batDau !== null) {
                        let ketThuc = i;
                        ngoacLon.push([batDau, ketThuc]);
                        batDau = null;
                    }
                }
            }
    
            return ngoacLon;
        }
    
        function extractLatexData(content) {
            const regexType1 = /\\begin\{ex\}[^]*?\\choice\s*(?!TF\s*\{)\s*([^]*?)\\loigiai/gs;
            const regexType2 = /\\begin\{ex\}[^]*?\\choiceTF\s*([^]*?)\\loigiai/gs;
            const regexType3 = /\\begin\{ex\}[^]*?\\shortans\{([^\}]*)\}/gs;
    
            let matches, extractedData = [];
    
            while ((matches = regexType1.exec(content)) !== null) {
                let choices = matches[1].trim();
                let ngoacLon = layCacNgoacLon(choices);
                if (ngoacLon.length >= 4) {
                    let answers = ngoacLon.slice(0, 4).map(pair => choices.substring(pair[0] + 1, pair[1]));
                    let correctAnswerIndex = answers.findIndex(answer => answer.includes('\\True'));
                    if (correctAnswerIndex !== -1) {
                        extractedData.push(String.fromCharCode(65 + correctAnswerIndex)); // Chuyển đổi sang A, B, C, D
                    } else {
                        extractedData.push("N/A");
                    }
                } else {
                    extractedData.push("N/A");
                }
            }
    
            while ((matches = regexType2.exec(content)) !== null) {
                let choices = matches[1].trim();
                let ngoacLon = layCacNgoacLon(choices);
                if (ngoacLon.length >= 4) {
                    let answers = ngoacLon.slice(0, 4).map(pair => choices.substring(pair[0] + 1, pair[1]));
                    let result = answers.map(answer => answer.includes('\\True') ? 'Đ' : 'S').join('');
                    extractedData.push(result);
                } else {
                    extractedData.push("N/A");
                }
            }
    
            while ((matches = regexType3.exec(content)) !== null) {
                let answer = matches[1].trim();
                let ngoacLon = layCacNgoacLon(answer);
                if (ngoacLon.length > 0) {
                    answer = answer.substring(ngoacLon[0][0] + 1, ngoacLon[0][1]).trim();
                }
                extractedData.push(answer.replace(/\$|\{|\}/g, '').trim());
            }
    
            return extractedData;
        }
    
        function mergeExtractedData(allExtractedData, currentMades) {
            let headers = ['Câu\\Mã đề'];
            let maxLength = Math.max(...allExtractedData.map(data => data.length));
            let mergedData = [];
    
            currentMades.forEach((currentMade, index) => {
                headers.push(`${currentMade}`);
            });
    
            allExtractedData.forEach((data, index) => {
                for (let i = 0; i < maxLength; i++) {
                    if (!mergedData[i]) {
                        mergedData[i] = [i + 1];
                    }
                    mergedData[i].push(data[i] || "N/A");
                }
            });
    
            return [headers, ...mergedData];
        }
    
        function extractAndExport(files, currentMades) {
            const allExtractedData = files.map(fileContent => extractLatexData(fileContent));
            const mergedData = mergeExtractedData(allExtractedData, currentMades);
    
            const ws = XLSX.utils.aoa_to_sheet(mergedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "extracted_data.xlsx");
        }
    
        $(document).ready(function () {
            let idMeanings = {};

        // Load JSON file
        loadJSON('ynghia_id.json', function(data) {
            idMeanings = data;
        });

        function getIdMeaning(id) {
            return idMeanings[id] || "ID không xác định";
        }


            $('#uploadForm').on('submit', function (e) {
                e.preventDefault();
                let fileInput = document.getElementById('uploadFile');
                let file = fileInput ? fileInput.files[0] : null;
                let school = $('#school').val();
                let teacher = $('#teacher').val();
                let exam = $('#exam').val();
                let subject = $('#subject').val();
                let time = $('#time').val();
                let made = $('#made').val().split(',').map(item => item.trim());
                let numFiles = document.getElementById('numFiles') ? document.getElementById('numFiles').value : null;
                let hoanViType = document.getElementById('hoanViType') ? document.getElementById('hoanViType').value : 'ngoac';
                let headerType = document.getElementById('headerType') ? document.getElementById('headerType').value : 'default';
                let phieuTo = document.getElementById('phieuTo') ? document.getElementById('phieuTo').value : 'phieu1';
                let dapAn = document.getElementById('dapAn') ? document.getElementById('dapAn').value : 'dap_an_1';
    
                if (file) {
                    let reader = new FileReader();
                    reader.onload = function (event) {
                        let content = event.target.result;
                        parseFile(content, school, teacher, exam, subject, time, made, numFiles, hoanViType, headerType, phieuTo, dapAn);
                    };
                    reader.readAsText(file);
                }
            });
    
            $('#permuteButton').on('click', function () {
                let content = collectContentFromTable();
                let numFiles = document.getElementById('numFiles') ? document.getElementById('numFiles').value : null;
                let hoanViType = document.getElementById('hoanViType') ? document.getElementById('hoanViType').value : 'ngoac';
                let headerType = document.getElementById('headerType') ? document.getElementById('headerType').value : 'default';
    
                let school = $('#school').val();
                let teacher = $('#teacher').val();
                let exam = $('#exam').val();
                let subject = $('#subject').val();
                let time = $('#time').val();
                let made = $('#made').val().split(',').map(item => item.trim());
                let phieuTo = document.getElementById('phieuTo') ? document.getElementById('phieuTo').value : 'phieu1';
                let dapAn = document.getElementById('dapAn') ? document.getElementById('dapAn').value : 'dap_an_1';
    
                if (content && numFiles) {
                    let { results, files, currentMades } = generateFiles(content, numFiles, hoanViType, headerType, school, teacher, exam, subject, time, made, phieuTo, dapAn);
                    displayResults(results);
                    alert('Hoán vị xong!');
                }
            });
    
            $('#pasteForm').on('submit', function (e) {
                e.preventDefault();
                let content = $('#pasteContent').val();
                let numFiles = document.getElementById('numPasteFiles') ? document.getElementById('numPasteFiles').value : null;
                let hoanViType = document.getElementById('hoanViTypePaste') ? document.getElementById('hoanViTypePaste').value : 'ngoac';
                let headerType = document.getElementById('headerTypePaste') ? document.getElementById('headerTypePaste').value : 'default';
    
                let school = $('#school').val();
                let teacher = $('#teacher').val();
                let exam = $('#exam').val();
                let subject = $('#subject').val();
                let time = $('#time').val();
                let made = $('#made').val().split(',').map(item => item.trim());
                let phieuTo = document.getElementById('phieuToPaste') ? document.getElementById('phieuToPaste').value : 'phieu1';
                let dapAn = document.getElementById('dapAnPaste') ? document.getElementById('dapAnPaste').value : 'dap_an_1';
    
                if (content && numFiles) {
                    let { results, files, currentMades } = generateFiles(content, numFiles, hoanViType, headerType, school, teacher, exam, subject, time, made, phieuTo, dapAn);
                    displayResults(results);
                    alert('Hoán vị xong!');
                }
            });
    
            $('#downloadXlsxButton').on('click', function () {
                let content = collectContentFromTable();
                let numFiles = document.getElementById('numFiles') ? document.getElementById('numFiles').value : null;
                let hoanViType = document.getElementById('hoanViType') ? document.getElementById('hoanViType').value : 'ngoac';
                let headerType = document.getElementById('headerType') ? document.getElementById('headerType').value : 'default';
                let school = $('#school').val();
                let teacher = $('#teacher').val();
                let exam = $('#exam').val();
                let subject = $('#subject').val();
                let time = $('#time').val();
                let made = $('#made').val().split(',').map(item => item.trim());
                let phieuTo = document.getElementById('phieuTo') ? document.getElementById('phieuTo').value : 'phieu1';
                let dapAn = document.getElementById('dapAn') ? document.getElementById('dapAn').value : 'dap_an_1';
    
                if (content && numFiles) {
                    let { results, files, currentMades } = generateFiles(content, numFiles, hoanViType, headerType, school, teacher, exam, subject, time, made, phieuTo, dapAn);
                    displayResults(results);
                    extractAndExport(files, currentMades);
                    alert('Hoán vị và ghi Excel xong!');
                }
            });
    
          ////

        function extractLatexData2(content) {
            const regexType1 = /\\begin\{ex\}[^]*?\\choice\s*(?!TF\s*\{)\s*([^]*?)\\loigiai/gs;
            const regexType2 = /\\begin\{ex\}[^]*?\\choiceTF\s*([^]*?)\\loigiai/gs;
            const regexType3 = /\\begin\{ex\}[^]*?\\shortans\{([^\}]*)\}/gs;

            let matches, extractedData = { type1: [], type2: [], type3: [] };

            // Process Type 1 Questions (\choice)
            while ((matches = regexType1.exec(content)) !== null) {
                let choices = matches[1].trim();
                let ngoacLon = layCacNgoacLon(choices);
                if (ngoacLon.length >= 4) {
                    let answers = ngoacLon.slice(0, 4).map(pair => choices.substring(pair[0] + 1, pair[1]));
                    let correctAnswerIndex = answers.findIndex(answer => answer.includes('\\True'));
                    if (correctAnswerIndex !== -1) {
                        extractedData.type1.push(String.fromCharCode(65 + correctAnswerIndex)); // Convert index to A, B, C, D
                    } else {
                        extractedData.type1.push("N/A");
                    }
                } else {
                    extractedData.type1.push("N/A");
                }
            }

            // Process Type 2 Questions (\choiceTF)
            while ((matches = regexType2.exec(content)) !== null) {
                let choices = matches[1].trim();
                let ngoacLon = layCacNgoacLon(choices);
                if (ngoacLon.length >= 4) {
                    let answers = ngoacLon.slice(0, 4).map(pair => choices.substring(pair[0] + 1, pair[1]));
                    let result = answers.map(answer => answer.includes('\\True') ? 'Đ' : 'S').join('');
                    extractedData.type2.push(result);
                } else {
                    extractedData.type2.push("N/A");
                }
            }

            // Process Type 3 Questions (\shortans)
            while ((matches = regexType3.exec(content)) !== null) {
                let answer = matches[1].trim();
                let ngoacLon = layCacNgoacLon(answer);
                if (ngoacLon.length > 0) {
                    answer = answer.substring(ngoacLon[0][0] + 1, ngoacLon[0][1]).trim();
                }
                extractedData.type3.push(answer.replace(/\$|\{|\}/g, '').trim());
            }

            return extractedData;
        }

        function createHorizontalXlsx2(allExtractedData, currentMades) {
            const header = ["Đề \\ Câu"].concat(Array.from({ length: 40 }, (_, i) => (i + 1).toString()));

            const ws_data = [header];

            // Tạo hàng dữ liệu cho mỗi đề
            for (let k = 0; k < allExtractedData.length; k++) {
                const dataRow = [currentMades[k]];
                for (let i = 0; i < 40; i++) {
                    dataRow.push(allExtractedData[k].type1[i] || "");
                }

                // Thêm dữ liệu phần 2 (tách ra từng ký tự) từ cột AP (cột 41)
                const type2_start_col = 41;
                for (let i = 0; i < allExtractedData[k].type2.length; i++) {
                    const characters = allExtractedData[k].type2[i].split('');
                    for (let j = 0; j < characters.length; j++) {
                        const colIndex = type2_start_col + j + i * 4;
                        dataRow[colIndex] = characters[j];
                    }
                }

                // Thêm dữ liệu phần 3 (không tách) từ cột BV (cột 74)
                const type3_start_col = 73;
                for (let i = 0; i < allExtractedData[k].type3.length; i++) {
                    const colIndex = type3_start_col + i;
                    dataRow[colIndex] = allExtractedData[k].type3[i];
                }

                ws_data.push(dataRow);
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "cham_thi.xlsx");
        }
   
        $('#downloadXlsxButtonTwo').on('click', function () {
                let content = collectContentFromTable();
                let numFiles = document.getElementById('numFiles') ? document.getElementById('numFiles').value : null;
                let hoanViType = document.getElementById('hoanViType') ? document.getElementById('hoanViType').value : 'ngoac';
                let headerType = document.getElementById('headerType') ? document.getElementById('headerType').value : 'default';
                let school = $('#school').val();
                let teacher = $('#teacher').val();
                let exam = $('#exam').val();
                let subject = $('#subject').val();
                let time = $('#time').val();
                let made = $('#made').val().split(',').map(item => item.trim());
                let phieuTo = document.getElementById('phieuTo') ? document.getElementById('phieuTo').value : 'phieu1';
                let dapAn = document.getElementById('dapAn') ? document.getElementById('dapAn').value : 'dap_an_1';

                if (content && numFiles) {
                    let { results, files, currentMades } = generateFiles(content, numFiles, hoanViType, headerType, school, teacher, exam, subject, time, made, phieuTo, dapAn);
                    displayResults(results);
                    let allExtractedData = files.map(fileContent => extractLatexData2(fileContent));
                    createHorizontalXlsx2(allExtractedData, currentMades);
                    alert('Hoán vị và ghi Excel mẫu 2 xong!');
                }
            });
       

          ///
            function parseFileGOC(content, school, teacher, exam, subject, time, made, numFiles, hoanViType, headerType, phieuTo, dapAn) {
                let sentences = content.match(/\\begin{ex}[\s\S]+?\\end{ex}/g);
                let tableBody = $('#latexTable tbody');
                tableBody.empty();
    
                if (!sentences) {
                    alert("Không tìm thấy câu hỏi nào trong tệp.");
                    return;
                }
    
                sentences.forEach((sentence, index) => {
                    let idPattern = /([6-9|0-2])([A-Z])([0-9])([YBKGTNHVC])([0-9])-([0-9])/g;
                    let ids = Array.from(sentence.matchAll(idPattern)).map(match => match[0]).join(', ');
                    let id_meaning = "ID Ý NGHĨA";  // Thay đổi tùy theo ý nghĩa của ID
    
                    let row = $('<tr></tr>');
                    row.append(`<td>${index + 1}</td>`);
                    row.append(`<td>${ids}</td>`);
                    row.append(`<td>${id_meaning}</td>`);
    
                    //let textArea = $('<textarea class="form-control"></textarea>');
                    // Thay đổi giá trị height để làm khung textarea lớn hơn
                    let textArea = $('<textarea class="form-control" style="height: 300px;"></textarea>');
                    textArea.val(sentence);
                    let cell = $('<td></td>');
                    cell.append(textArea);
                    row.append(cell);
    
                    let checkbox = $('<input type="checkbox">');
                    let checkboxCell = $('<td></td>');
                    checkboxCell.append(checkbox);
                    row.append(checkboxCell);
    
                    if (sentence.includes('choice') && !sentence.includes('choiceTF')) {
                        row.css('background-color', '#FFEB3B'); // Yellow for choice
                    } else if (sentence.includes('choiceTF')) {
                        row.css('background-color', '#8BC34A'); // Green for choiceTF
                    } else {
                        row.css('background-color', '#03A9F4'); // Blue for others
                    }
    
                    tableBody.append(row);
                });
    
                $('#resultSection').show();
            }
    // Function to parse file content and display in the table
    function parseFile(content, school, teacher, exam, subject, time, made, numFiles, hoanViType, headerType, phieuTo, dapAn) {
            let sentences = content.match(/\\begin{ex}[\s\S]+?\\end{ex}/g);
            let tableBody = $('#latexTable tbody');
            tableBody.empty();

            if (!sentences) {
                alert("Không tìm thấy câu hỏi nào trong tệp.");
                return;
            }

            sentences.forEach((sentence, index) => {
                let idPattern = /([6-9|0-2])([A-Z])([0-9])([YBKGTNHVC])([0-9])-([0-9])/g;
                let ids = Array.from(sentence.matchAll(idPattern)).map(match => match[0]).join(', ');
                let id_meaning = ids.split(', ').map(id => getIdMeaning(id)).join(', ');

                let row = $('<tr></tr>');
                row.append(`<td style="width: 5%;">${index + 1}</td>`);
                row.append(`<td style="width: 10%;">${ids}</td>`);
                row.append(`<td style="width: 15%;">${id_meaning}</td>`);

                let textArea = $('<textarea class="form-control" style="height: 200px;"></textarea>');
                textArea.val(sentence);
                let cell = $('<td style="width: 70%;"></td>');
                cell.append(textArea);
                row.append(cell);

                let checkbox = $('<input type="checkbox">');
                let checkboxCell = $('<td style="width: 5%;"></td>');
                checkboxCell.append(checkbox);
                row.append(checkboxCell);

                if (sentence.includes('choice') && !sentence.includes('choiceTF')) {
                    row.css('background-color', '#FFEB3B'); // Yellow for choice
                } else if (sentence.includes('choiceTF')) {
                    row.css('background-color', '#8BC34A'); // Green for choiceTF
                } else {
                    row.css('background-color', '#03A9F4'); // Blue for others
                }

                tableBody.append(row);
            });

            $('#resultSection').show();
        }

            function collectContentFromTable() {
                let tableBody = $('#latexTable tbody');
                let content = '';
    
                tableBody.find('tr').each(function () {
                    let textArea = $(this).find('textarea');
                    let sentence = textArea.val();
                    content += sentence + '\n';
                });
    
                return content;
            }
    
            function displayResults(results) {
                $('#results').empty();
                results.forEach(function (result, index) {
                    let resultHtml = `
                <h3>File ${index + 1}</h3>
                <textarea class="form-control mb-3" rows="10" readonly>${result.content}</textarea>
                <a href="${result.download_url}" class="btn btn-success mb-3" download="hoanvi_${index + 1}.tex">Tải về file đã hoán vị</a>
                <button class="btn btn-primary mb-3" onclick="copyToClipboard(\`${result.content.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r')}\`)">Copy nội dung</button>
            `;
                    $('#results').append(resultHtml);
                });
                $('#resultSection').show();
            }
    
            function copyToClipboard(text) {
                let tempTextarea = document.createElement('textarea');
                tempTextarea.value = text;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextarea);
                alert('Đã copy nội dung vào clipboard!');
            }
    
            function hoanViCacNgoacLon(noiDung) {
                let cacVitriNgoacLon = layCacNgoacLon(noiDung).slice(0, 4);
    
                if (cacVitriNgoacLon.length === 4) {
                    let cacNgoacLonGoc = cacVitriNgoacLon.map(([dau, cuoi]) => noiDung.slice(dau, cuoi + 1));
                    let cacNgoacLonHoanVi = [...cacNgoacLonGoc];
    
                    for (let i = cacNgoacLonHoanVi.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [cacNgoacLonHoanVi[i], cacNgoacLonHoanVi[j]] = [cacNgoacLonHoanVi[j], cacNgoacLonHoanVi[i]];
                    }
    
                    cacNgoacLonGoc.forEach((goc, index) => {
                        noiDung = noiDung.replace(goc, cacNgoacLonHoanVi[index]);
                    });
                }
    
                return noiDung;
            }
    
            function hoanViNgoacLonNgauNhien(text) {
                let sentences = text.match(/\\begin{ex}[\s\S]+?\\end{ex}/g);
    
                if (!sentences) {
                    return {
                        groupChoice: '',
                        groupchoiceTF: '',
                        groupNone: '',
                        countChoice: 0,
                        countchoiceTF: 0,
                        countNone: 0
                    };
                }
    
                let groupChoice = [];
                let groupchoiceTF = [];
                let groupNone = [];
    
                sentences.forEach(sentence => {
                    if (sentence.includes('choice') && !sentence.includes('choiceTF')) {
                        groupChoice.push(sentence);
                    } else if (sentence.includes('choiceTF')) {
                        groupchoiceTF.push(sentence);
                    } else {
                        groupNone.push(sentence);
                    }
                });
    
                function processGroup(group) {
                    return group.map(sentence => {
                        let indexChoice = sentence.search(/\\choice|\\choiceTF|\\choiceTFt|\\choiceTF\[t\]|\\choiceTF\[n\]/);
                        if (indexChoice !== -1) {
                            let noiDungTruocChoice = sentence.slice(0, indexChoice);
                            let noiDungSauChoice = sentence.slice(indexChoice);
                            noiDungSauChoice = hoanViCacNgoacLon(noiDungSauChoice);
    
                            return noiDungTruocChoice + noiDungSauChoice;
                        }
                        return sentence;
                    });
                }
    
                groupChoice = processGroup(groupChoice);
                groupchoiceTF = processGroup(groupchoiceTF);
                groupNone = groupNone.map(sentence => sentence);
    
                return {
                    groupChoice: groupChoice.join('\n'),
                    groupchoiceTF: groupchoiceTF.join('\n'),
                    groupNone: groupNone.join('\n'),
                    countChoice: groupChoice.length,
                    countchoiceTF: groupchoiceTF.length,
                    countNone: groupNone.length
                };
            }
    
            function hoanViCauTruc(text) {
                let sentences = text.match(/\\begin{ex}[\s\S]+?\\end{ex}/g);
    
                if (!sentences) {
                    return {
                        groupChoice: '',
                        groupchoiceTF: '',
                        groupNone: '',
                        countChoice: 0,
                        countchoiceTF: 0,
                        countNone: 0
                    };
                }
    
                sentences.sort(() => Math.random() - 0.5);
    
                let groupChoice = [];
                let groupchoiceTF = [];
                let groupNone = [];
    
                sentences.forEach(sentence => {
                    if (sentence.includes('choice') && !sentence.includes('choiceTF')) {
                        groupChoice.push(sentence);
                    } else if (sentence.includes('choiceTF')) {
                        groupchoiceTF.push(sentence);
                    } else {
                        groupNone.push(sentence);
                    }
                });
    
                function processGroup(group) {
                    return group.map(sentence => {
                        let indexChoice = sentence.search(/\\choice|\\motcot|\\haicot|\\choice\[2\]|\\choiceTF|\\choiceTFt|\\choiceTF\[t\]|\\choiceTF\[n\]/);
                        if (indexChoice !== -1) {
                            let noiDungTruocChoice = sentence.slice(0, indexChoice);
                            let noiDungSauChoice = sentence.slice(indexChoice);
                            noiDungSauChoice = hoanViCacNgoacLon(noiDungSauChoice);
    
                            return noiDungTruocChoice + noiDungSauChoice;
                        }
                        return sentence;
                    });
                }
    
                groupChoice = processGroup(groupChoice);
                groupchoiceTF = processGroup(groupchoiceTF);
                groupNone = processGroup(groupNone);
    
                return {
                    groupChoice: groupChoice.join('\n'),
                    groupchoiceTF: groupchoiceTF.join('\n'),
                    groupNone: groupNone.join('\n'),
                    countChoice: groupChoice.length,
                    countchoiceTF: groupchoiceTF.length,
                    countNone: groupNone.length
                };
            }
    
            function getHeaderContent(type, school, teacher, exam, subject, time,phieuto) {
                const headers = {
                    default: `\\documentclass[12pt,a4paper]{article}
\\usepackage{amsmath,amssymb,makecell,fancyhdr,enumerate,arcs,physics,tasks,mathrsfs,graphics}
\\usepackage{tikz,tikz-3dplot,tkz-euclide,tkz-tab,tkz-linknodes,tabvar,pgfplots,esvect}
\\usepackage[top=1.5cm, bottom=1.5cm, left=2cm, right=1.5cm]{geometry}
\\usepackage[hidelinks,unicode]{hyperref}
\\usepackage[utf8]{vietnam}
\\usepackage[dethi]{ex_test}
\\usetikzlibrary{shapes.geometric,shadings,calc,snakes,patterns,arrows,intersections,angles,backgrounds,quotes}
\\usepgfplotslibrary{fillbetween}
\\pgfplotsset{compat=newest}
\\tikzset{point style/.append style={color=white}}
\\def\\vec{\\overrightarrow}
\\newcommand{\\hoac}[1]{\\left[\\begin{aligned}#1\\end{aligned}\\right.}
\\newcommand{\\heva}[1]{\\left\\{\\begin{aligned}#1\\end{aligned}\\right.}
\\newcommand{\\hetde}{\\centerline{\\rule[0.5ex]{2cm}{1pt} HẾT \\rule[0.5ex]{2cm}{1pt}}}
\\newcommand{\\tentruong}{${school}}
    \\newcommand{\\tengv}{${teacher}}
    \\newcommand{\\tenkythi}{${exam}}
    \\newcommand{\\tenmonthi}{${subject}}
    \\newcommand{\\thoigian}{${time}}
    \\newcommand{\\tieude}[3]{
	\\noindent
	%Trái
	\\begin{minipage}[b]{7cm}
		\\centerline{\\textbf{\\fontsize{13}{0}\\selectfont \\tentruong}}
		\\centerline{\\textbf{\\fontsize{13}{0}\\selectfont \\tengv}}
		\\centerline{(\\textit{Đề thi có #1\\ trang})}
		\\centerline{\\textit{ }}
	\\end{minipage}\\hspace{1.5cm}
	%Phải
	\\begin{minipage}[b]{9cm}
		\\centerline{\\textbf{\\fontsize{13}{0}\\selectfont \\tenkythi}}
		\\centerline{\\textbf{\\fontsize{13}{0}\\selectfont \\tenmonthi}}
		\\centerline{\\textit{\\fontsize{12}{0}\\selectfont Thời gian làm bài \\thoigian \\ phút }}
		\\centerline{\\textit{\\fontsize{12}{0}\\selectfont (Đề có 11 câu trắc nghiệm,11 câu đúng sai,11 câu điền đáp án)}}
	\\end{minipage}
	\\begin{minipage}[b]{13cm}
		\\vspace*{.75cm}
		\\textbf{Họ và tên thí sinh: }{\\tiny\\dotfill}\\\\
		\\textbf{Số Báo Danh: }{\\tiny\\dotfill}
	\\end{minipage}
	\\begin{minipage}[b]{8cm}
		\\hspace*{1cm}\\fbox{\\bf Mã đề thi #3}
	\\end{minipage}
}
\\newcommand{\\chantrang}[2]{\\rfoot{Trang \\thepage/#1 $-$ Mã đề #2}}
\\pagestyle{fancy}
\\fancyhf{}
\\renewcommand{\\headrulewidth}{0pt}
\\def\\colorEX{}% màu phương án đúng
\\renewtheorem{ex}{\\color{blue!80!black}\\textbf{Câu}}
    `,
                    option1: `
    \\newcommand{\\tentruong}{${school}}
    \\newcommand{\\tengv}{${teacher}}
    \\newcommand{\\tenkythi}{${exam}}
    \\newcommand{\\tenmonthi}{${subject}}
    \\newcommand{\\thoigian}{${time}}
    \\newcommand{\\tieude}[2]{
    \\noindent
    `
                };
    
                return headers[type] || headers['default'];
            }
    
            function generateFiles(content, numFiles, hoanViType, headerType, school, teacher, exam, subject, time, made, phieuTo, dapAn) {
                let results = [];
                let headerContent = getHeaderContent(headerType, school, teacher, exam, subject, time,phieuTo);
                const phieuToContent = `\\section*{Phiếu Tô ${phieuTo}}\n\\section*{Đáp án ${dapAn}}\n`;
                let files = [];
                let currentMades = []; // Mảng chứa các currentMade
    
                for (let i = 0; i < numFiles; i++) {
                    let resultContent;
                    let hoanViKetQua;
    
                    if (hoanViType === 'ngoac') {
                        hoanViKetQua = hoanViNgoacLonNgauNhien(content);
                    } else if (hoanViType === 'cau_truc') {
                        hoanViKetQua = hoanViCauTruc(content);
                    } else if (hoanViType === 'giu_nguyen') {
                        hoanViKetQua = {
                            groupChoice: content,
                            groupchoiceTF: '',
                            groupNone: '',
                            countChoice: 0,
                            countchoiceTF: 0,
                            countNone: 0
                        };
                    }
    
                    let currentMade = made[i % made.length];
                    currentMades.push(currentMade); // Lưu lại currentMade
    
                    resultContent = `
    ${headerContent}
    \\newcommand{\\made}{${currentMade}}
    \\begin{document}   
    \\tieude{\\pageref{\\made}}{0}{\\made}
    \\chantrang{\\pageref{\\made}}{\\made}
     ${getPhieuToContent(phieuTo)}
    \\subsection*{PHẦN I. Câu trắc nghiệm nhiều phương án lựa chọn. Thí sinh trả lời từ câu 1 đến câu ${hoanViKetQua.countChoice}}. Mỗi câu hỏi thí sinh chỉ chọn một phương án.
    \\setcounter{ex}{0}
    \\Opensolutionfile{ans}[ans/ans-phanI]
    ${hoanViKetQua.groupChoice}
    \\Closesolutionfile{ans}
    
    \\subsection*{PHẦN II. Câu trắc nghiệm đúng sai. Thí sinh trả lời từ câu 1 đến câu ${hoanViKetQua.countchoiceTF}}. Trong mỗi ý a), b), c), d) ở mỗi câu, thí sinh chọn đúng hoặc sai.
    \\setcounter{ex}{0}
    \\Opensolutionfile{ans}[ans/ans-phanII]
    ${hoanViKetQua.groupchoiceTF}
    \\Closesolutionfile{ans}
    
    \\subsection*{PHẦN III. Câu trắc nghiệm trả lời ngắn. Thí sinh trả lời từ câu 1 đến câu ${hoanViKetQua.countNone}.}
    \\setcounter{ex}{0}
    \\Opensolutionfile{ans}[ans/ans-phanIII]
    ${hoanViKetQua.groupNone}
    \\Closesolutionfile{ans}
    
    \\hetde\\label{\\made}
    \\newpage
    \\begin{center}
    \\textbf{\\large BẢNG ĐÁP ÁN}
    \\end{center}
    \\noindent\\textbf{A. ĐÁP ÁN PHẦN I}
    \\inputansbox{10}{ans/ans-phanI}
    \\noindent\\textbf{B. ĐÁP ÁN PHẦN II}
    \\inputansbox[2]{2}{ans/ans-phanII}
    \\noindent\\textbf{C. ĐÁP ÁN PHẦN III}
    \\inputansbox[3]{6}{ans/ans-phanIII}
    \\end{document}
    `;
    
                    results.push({
                        content: resultContent,
                        download_url: `data:text/plain;charset=utf-8,${encodeURIComponent(resultContent)}`
                    });
                    files.push(resultContent);
                }
    
                return { results, files, currentMades }; // Trả về thêm currentMades
            }
    
            function createHorizontalXlsx(allExtractedData, currentMades) {
                const mergedData = mergeExtractedDataForHorizontal(allExtractedData, currentMades);
                
                const ws = XLSX.utils.aoa_to_sheet(mergedData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, "extracted_data_horizontal.xlsx");
            }
    
            function mergeExtractedDataForHorizontal(allExtractedData, currentMades) {
                let headers = ['Đề \\ Câu', ...Array.from({ length: 40 }, (_, i) => (i + 1).toString())];
                for (let i = 1; i <= 8; i++) {
                    for (let j = 0; j < 4; j++) {
                        headers.push(`${i}${['a', 'b', 'c', 'd'][j]}`);
                    }
                }
                headers.push(...Array.from({ length: 6 }, (_, i) => (i + 1).toString()));
    
                let mergedData = [headers];
    
                allExtractedData.forEach((data, index) => {
                    let row = [currentMades[index]];
                    let part1 = data.slice(0, 40);
                    let part2 = data.slice(40, 72).flatMap(answer => answer.split(''));
                    let part3 = data.slice(72);
    
                    row.push(...part1, ...part2, ...part3);
                    mergedData.push(row);
                });
    
                return mergedData;
            }
        
        });
    </script>
    
 
</body>
</html>
